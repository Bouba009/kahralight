<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KahraLight Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #0044cc;
            --secondary: #ff9900;
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #1a1a1a;
            --text-sub: #666666;
            --ticker-bg: #fff700;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
            --radius: 12px;
        }

        /* Themes */
        body.theme-dark-blue { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #fff; --text-sub: #cbd5e1; --primary: #3b82f6; }
        body.theme-orange-blue { --primary: #ff9900; --secondary: #0044cc; }
        body.theme-yellow-white { --bg-body: #fff; --primary: #ffd700; --secondary: #000; --text-main: #000; }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Cairo', 'Roboto', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; padding-bottom: 0; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        img { max-width: 100%; display: block; }

        /* Header */
        header { background: var(--bg-card); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 900; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-size: 26px; font-weight: 900; }
        .logo span:first-child { color: var(--primary); }
        .logo span:last-child { color: var(--secondary); text-shadow: 0 0 10px var(--secondary); }
        .search-box { flex: 1; margin: 0 20px; max-width: 500px; display: none; }
        @media(min-width: 768px) { .search-box { display: block; } }
        .search-box input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; background: #f9f9f9; }
        .nav-tools { display: flex; gap: 15px; align-items: center; }
        .lang-select { border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: var(--bg-card); color: var(--text-main); font-size: 14px; cursor: pointer; }
        .icon-btn { font-size: 1.2rem; cursor: pointer; position: relative; }
        .badge { position: absolute; top: -8px; right: -8px; background: red; color: white; font-size: 10px; padding: 3px 6px; border-radius: 50%; }

        /* Sidebar */
        .sidebar { position: fixed; top: 0; width: 280px; height: 100%; background: var(--bg-card); z-index: 1000; padding: 20px; transition: 0.3s; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        html[dir="rtl"] .sidebar { right: -290px; } html[dir="rtl"] .sidebar.active { right: 0; }
        html[dir="ltr"] .sidebar { left: -290px; } html[dir="ltr"] .sidebar.active { left: 0; }
        .cat-link { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: 600; display:flex; justify-content:space-between; }
        .cat-link:hover { background: var(--primary); color: #fff; }

        /* Pages */
        .page-section { display: none; min-height: 80vh; animation: fadeIn 0.4s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* Slider & Ticker */
        .hero-slider { height: 250px; position: relative; overflow: hidden; }
        @media(min-width: 768px) { .hero-slider { height: 450px; } }
        .slide { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 1s; }
        .slide.active { opacity: 1; }
        .ticker-wrap { background: var(--ticker-bg); overflow: hidden; height: 45px; display: flex; align-items: center; border-bottom: 1px solid #ddd; }
        .ticker-content { white-space: nowrap; font-weight: 800; color: #000; font-size: 15px; display: inline-block; padding-left: 100%; }
        
        /* Product Grid */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); gap: 30px; } }
        .product-card { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: 0.3s; cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.05); }
        .product-card:hover { transform: translateY(-7px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .p-img { width: 100%; height: 200px; object-fit: contain; background: #fff; padding: 10px; }
        .p-info { padding: 15px; }
        .p-cat { font-size: 11px; color: var(--text-sub); text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }
        .p-title { font-weight: 700; margin: 5px 0; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        
        /* Full Product Page */
        #product-full-page { background: var(--bg-card); padding-top: 20px; }
        .prod-container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 30px; padding: 20px; }
        @media(min-width: 768px) { .prod-container { flex-direction: row; } }
        .prod-gallery { flex: 1.2; background: #fff; border-radius: 10px; overflow: hidden; position: relative; }
        .main-view-img { width: 100%; height: auto; max-height: 500px; object-fit: contain; }
        .thumbs-row { display: flex; gap: 10px; padding: 10px; overflow-x: auto; }
        .thumb-img { width: 70px; height: 70px; border: 2px solid #eee; border-radius: 5px; cursor: pointer; object-fit: cover; }
        .prod-details { flex: 1; padding: 10px; }
        .btn-main { width: 100%; padding: 15px; background: var(--primary); color: #fff; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-main:hover { background: var(--secondary); }

        /* Footer */
        footer { background: #111; color: #bbb; padding: 60px 20px 20px; margin-top: 50px; font-size: 14px; }
        .footer-grid { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; }
        .footer-col h3 { color: #fff; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid var(--secondary); display: inline-block; padding-bottom: 5px; }
        .footer-form input, .footer-form textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #333; color: #fff; border-radius: 4px; }
        .footer-bottom { border-top: 1px solid #333; margin-top: 50px; padding-top: 20px; text-align: center; }

        /* Admin */
        .admin-overlay { position: fixed; inset: 0; background: #fff; z-index: 5000; display: none; align-items: center; justify-content: center; }
        #admin-panel { display: none; min-height: 100vh; background: #f1f5f9; }
        .admin-nav { background: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .stat-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center; border-bottom: 4px solid var(--primary); }
        .admin-content { max-width: 1000px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 12px; display: none; }
        .admin-content.active { display: block; }
        .admin-tabs { display: flex; justify-content: center; gap: 10px; padding: 20px 0; background: #fff; }
        .tab-btn { padding: 10px 25px; border: none; background: #e2e8f0; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: #fff; }
        
        .form-row { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
        label { font-weight: bold; font-size: 13px; }

        /* Anim */
        @keyframes ticker-rtl { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes ticker-ltr { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .check-anim { font-size: 80px; color: #2ecc71; animation: pop 0.5s; }
        @keyframes pop { 0%{transform:scale(0)} 70%{transform:scale(1.2)} 100%{transform:scale(1)} }

    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div style="display: flex; gap:15px; align-items: center;">
            <div class="icon-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <div class="logo"><span>Kahra</span><span>Light</span></div>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" onkeyup="renderProds(null, this.value)" placeholder="Search...">
        </div>
        <div class="nav-tools">
            <select class="lang-select" onchange="changeLang(this.value)">
                <option value="ar">ðŸ‡©ðŸ‡¿ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                <option value="en">ðŸ‡¬ðŸ‡§ English</option>
            </select>
            <div class="icon-btn" onclick="openAdminLogin()"><i class="fas fa-user-circle"></i></div>
            <div class="icon-btn"><i class="fas fa-shopping-bag"></i> <span class="badge" id="cartCount">0</span></div>
        </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #eee;">
            <h3 data-key="categories">Categories</h3>
            <i class="fas fa-times" onclick="toggleSidebar()" style="cursor:pointer; font-size:20px;"></i>
        </div>
        <div id="cat-list"></div>
    </div>

    <!-- HOME PAGE -->
    <div id="page-home" class="page-section active">
        <div class="hero-slider" id="slider-container"></div>
        <div class="ticker-wrap"><div class="ticker-content" id="ticker-text"></div></div>
        <div class="container">
            <h2 style="margin-bottom: 25px;" data-key="all_products">All Products</h2>
            <div class="grid" id="product-grid"></div>
        </div>
        <footer>
            <div class="footer-grid">
                <div class="footer-col">
                    <h3 data-key="about">About Us</h3>
                    <p data-key="about_text">KahraLight is your #1 source for electrical supplies.</p>
                </div>
                <div class="footer-col">
                    <h3 data-key="links">Quick Links</h3>
                    <a href="#" data-key="home">Home</a>
                    <a href="#" data-key="privacy">Privacy Policy</a>
                    <a href="#" data-key="contact">Contact Us</a>
                </div>
                <div class="footer-col">
                    <h3 data-key="report">Report a Problem</h3>
                    <form class="footer-form" onsubmit="submitReport(event)">
                        <input type="text" id="rep-name" placeholder="Name" required>
                        <input type="email" id="rep-email" placeholder="Email" required>
                        <textarea id="rep-msg" rows="3" placeholder="Message" required></textarea>
                        <button style="background:var(--secondary); border:none; padding:8px 15px; color:#000; font-weight:bold; cursor:pointer;" data-key="send">Send</button>
                    </form>
                </div>
            </div>
            <div class="footer-bottom">&copy; 2024 KahraLight Store.</div>
        </footer>
    </div>

    <!-- PRODUCT PAGE -->
    <div id="page-product" class="page-section">
        <div class="container">
            <div style="margin-bottom:20px; cursor:pointer; font-weight:bold;" onclick="showPage('home')">
                <i class="fas fa-arrow-left"></i> <span data-key="back">Back</span>
            </div>
            <div class="prod-container">
                <div class="prod-gallery">
                    <img id="view-img" class="main-view-img" src="">
                    <div class="thumbs-row" id="view-thumbs"></div>
                </div>
                <div class="prod-details">
                    <div class="p-cat" id="view-cat"></div>
                    <h1 class="prod-title" id="view-title"></h1>
                    <div class="prod-price" id="view-price"></div>
                    <div class="prod-desc" id="view-desc"></div>
                    
                    <!-- DOCS LINKS -->
                    <div id="doc-links" style="margin: 20px 0; display:flex; gap:15px;"></div>

                    <div style="background:#f9f9f9; padding:20px; border-radius:10px; margin-top:20px;">
                        <h3 style="margin-bottom:15px;" data-key="order_form">Order Form</h3>
                        <div class="form-row" style="display:flex; gap:10px;">
                            <div style="flex:1"><label data-key="qty">Quantity</label><input type="number" id="ord-qty" value="1" min="1" class="form-input"></div>
                            <div style="flex:1"><label data-key="color">Color</label><select id="ord-color" class="form-input"></select></div>
                        </div>
                        <input type="text" id="ord-name" placeholder="Full Name" class="form-input" style="margin-bottom:10px;">
                        <input type="tel" id="ord-phone" placeholder="Phone" class="form-input" style="margin-bottom:10px;">
                        <select id="ord-country" class="form-input" style="margin-bottom:10px;">
                            <option value="Algeria">Algeria ðŸ‡©ðŸ‡¿</option>
                            <option value="Spain">Spain ðŸ‡ªðŸ‡¸</option>
                            <option value="France">France ðŸ‡«ðŸ‡·</option>
                            <option value="Portugal">Portugal ðŸ‡µðŸ‡¹</option>
                        </select>
                        <textarea id="ord-addr" placeholder="Address" class="form-input" style="margin-bottom:10px;"></textarea>
                        <button class="btn-main" onclick="submitOrder()" data-key="buy_now">Confirm Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SUCCESS -->
    <div id="success-overlay" class="admin-overlay" style="background:rgba(255,255,255,0.95); flex-direction:column;">
        <i class="fas fa-check-circle check-anim"></i>
        <h2 style="margin-top:20px;" data-key="success_order">Order Successful!</h2>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="admin-login" class="admin-overlay">
        <div style="background:#fff; padding:40px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1); width:90%; max-width:350px; text-align:center;">
            <h2 style="color:var(--primary); margin-bottom:20px;">Admin</h2>
            <input type="text" id="adm-user" placeholder="Username" class="form-input">
            <input type="password" id="adm-pass" placeholder="Password" class="form-input">
            <button onclick="login()" class="btn-main" style="margin-top:15px;">Login</button>
            <p id="login-msg" style="color:red; margin-top:10px; display:none;">Error</p>
            <button onclick="document.getElementById('admin-login').style.display='none'" style="background:none; border:none; margin-top:15px; text-decoration:underline;">Cancel</button>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel">
        <div class="admin-nav">
            <h3>Admin Dashboard</h3>
            <div>
                <button onclick="logout()" style="background:#e74c3c; color:#fff; padding:8px 15px; border:none; border-radius:5px;">Logout</button>
                <button onclick="closeAdmin()" style="background:#34495e; color:#fff; padding:8px 15px; border:none; border-radius:5px;">Store</button>
            </div>
        </div>
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('dash')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('products')">Products</button>
            <button class="tab-btn" onclick="switchTab('orders')">Orders</button>
            <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dash" class="admin-content active">
            <div class="dashboard-grid">
                <div class="stat-card"><div class="stat-val" id="st-visits">0</div><div>Visits</div></div>
                <div class="stat-card"><div class="stat-val" id="st-today">0</div><div>Today</div></div>
                <div class="stat-card"><div class="stat-val" id="st-orders">0</div><div>Orders</div></div>
                <div class="stat-card"><div class="stat-val" id="st-total">0</div><div>Total</div></div>
            </div>
        </div>

        <!-- Products -->
        <div id="tab-products" class="admin-content">
            <h3>Manage Products</h3>
            
            <!-- CSV IMPORT -->
            <div style="background:#e8f4fd; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #bde0fe;">
                <h4>Import CSV</h4>
                <input type="file" id="csv-file" accept=".csv" style="margin-top:5px;">
                <button onclick="importCSV()" style="padding:5px 10px;">Upload CSV</button>
            </div>

            <!-- PRODUCT FORM -->
            <div style="background:#f8fafc; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #e2e8f0;">
                <input type="hidden" id="edit-id">
                <label>Basic Info</label>
                <div class="form-row" style="display:flex; gap:10px;">
                    <input type="text" id="np-name" placeholder="Product Name" class="form-input">
                    <input type="text" id="np-cat" placeholder="Category" class="form-input">
                </div>
                <div class="form-row" style="display:flex; gap:10px;">
                    <input type="number" id="np-price-dz" placeholder="Price DA" class="form-input">
                    <input type="number" id="np-price-eu" placeholder="Price â‚¬" class="form-input">
                </div>
                <label>Details</label>
                <textarea id="np-desc" placeholder="Description" class="form-input"></textarea>
                <input type="text" id="np-colors" placeholder="Colors (red, blue...)" class="form-input">
                
                <label style="margin-top:10px; display:block;">Images & Files (URLs or Uploads)</label>
                <input type="text" id="np-img" placeholder="Image URL 1, Image URL 2..." class="form-input">
                <input type="file" id="np-img-file" class="form-input" multiple>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1">
                        <label>Export Cert.</label>
                        <input type="file" id="np-cert-file" class="form-input">
                    </div>
                    <div style="flex:1">
                        <label>Fiche Tech.</label>
                        <input type="file" id="np-fiche-file" class="form-input">
                    </div>
                </div>

                <button onclick="saveProduct()" class="btn-main" style="background:#27ae60; margin-top:20px;">Save Product</button>
                <button onclick="clearForm()" style="margin-top:10px; width:100%; background:#95a5a6; border:none; padding:10px; color:#fff; cursor:pointer;">Clear / New</button>
            </div>
            
            <div id="admin-prod-list"></div>
        </div>

        <!-- Orders -->
        <div id="tab-orders" class="admin-content">
            <h3>Recent Orders</h3>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; margin-top:15px;">
                    <thead style="background:#f1f1f1;"><tr><th style="padding:10px;">Date</th><th>Customer</th><th>Product</th><th>Price</th></tr></thead>
                    <tbody id="admin-orders-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Settings -->
        <div id="tab-settings" class="admin-content">
            <h3>Global Settings</h3>
            <p style="font-size:12px; color:red;">* Changes here will affect ALL users.</p>
            <label>Theme</label>
            <select id="set-theme" class="form-input" onchange="saveGlobalSettings()">
                <option value="default">Default</option>
                <option value="theme-dark-blue">Dark Blue</option>
                <option value="theme-orange-blue">Orange Primary</option>
                <option value="theme-yellow-white">Yellow/White</option>
            </select>
            
            <h4 style="margin-top:20px;">Ticker Text</h4>
            <input type="text" id="tick-ar" placeholder="Arabic" class="form-input">
            <input type="text" id="tick-fr" placeholder="French" class="form-input">
            <input type="text" id="tick-es" placeholder="Spanish" class="form-input">
            <input type="text" id="tick-en" placeholder="English" class="form-input">
            
            <button onclick="saveGlobalSettings()" class="btn-main" style="margin-top:15px;">Update All Users</button>
            
            <h4 style="margin-top:20px;">Slider Images</h4>
            <input type="text" id="slider-url" placeholder="Image URL" class="form-input">
            <button onclick="addSlideImg()" style="padding:10px; margin-top:5px;">Add Slide</button>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
          projectId: "mourafik-e9161",
          appId: "1:133465287328:web:9de5b3bd709099d885b7c5"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected");
        } catch(e) { console.error("Firebase Error", e); }

        // STATE
        let state = {
            lang: 'ar',
            currency: 'DA',
            products: [],
            orders: [],
            settings: {
                theme: 'default',
                slider: ['https://via.placeholder.com/1200x400/0044cc/fff?text=Kahra', 'https://via.placeholder.com/1200x400/ff9900/fff?text=Light'],
                ticker: { ar: 'Ù…Ø±Ø­Ø¨Ø§', fr: 'Bienvenue', es: 'Hola', en: 'Welcome' }
            },
            visits: 100
        };

        const i18n = {
            ar: { categories: 'Ø§Ù„ÙØ¦Ø§Øª', all_products: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', about: 'Ù…Ù† Ù†Ø­Ù†', about_text: 'Ù…ØµØ¯Ø±Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡.', links: 'Ø±ÙˆØ§Ø¨Ø·', home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', privacy: 'Ø§Ù„Ø®ØµÙˆØµÙŠØ©', contact: 'Ø§ØªØµÙ„ Ø¨Ù†Ø§', report: 'Ø§Ø¨Ù„Ø§Øº', send: 'Ø§Ø±Ø³Ø§Ù„', back: 'Ø¹ÙˆØ¯Ø©', order_form: 'Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨', qty: 'Ø§Ù„ÙƒÙ…ÙŠØ©', color: 'Ø§Ù„Ù„ÙˆÙ†', buy_now: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', success_order: 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­' },
            fr: { categories: 'CatÃ©gories', all_products: 'Produits', about: 'Ã€ propos', about_text: 'Votre source nÂ°1.', links: 'Liens', home: 'Accueil', privacy: 'ConfidentialitÃ©', contact: 'Contact', report: 'Signaler', send: 'Envoyer', back: 'Retour', order_form: 'Commande', qty: 'QtÃ©', color: 'Couleur', buy_now: 'Confirmer', success_order: 'SuccÃ¨s' },
            es: { categories: 'CategorÃ­as', all_products: 'Productos', about: 'Nosotros', about_text: 'Su fuente n.1', links: 'Enlaces', home: 'Inicio', privacy: 'Privacidad', contact: 'Contacto', report: 'Reportar', send: 'Enviar', back: 'Volver', order_form: 'Pedido', qty: 'Cant', color: 'Color', buy_now: 'Confirmar', success_order: 'Ã‰xito' },
            en: { categories: 'Categories', all_products: 'Products', about: 'About', about_text: 'Your #1 source.', links: 'Links', home: 'Home', privacy: 'Privacy', contact: 'Contact', report: 'Report', send: 'Send', back: 'Back', order_form: 'Order', qty: 'Qty', color: 'Color', buy_now: 'Confirm', success_order: 'Success' }
        };

        // --- GLOBAL ---
        window.changeLang = (l) => {
            state.lang = l;
            document.documentElement.lang = l;
            document.documentElement.dir = l === 'ar' ? 'rtl' : 'ltr';
            state.currency = l === 'ar' ? 'DA' : 'â‚¬';
            
            document.querySelectorAll('[data-key]').forEach(el => {
                if(i18n[l][el.dataset.key]) el.innerText = i18n[l][el.dataset.key];
            });
            
            const tEl = document.getElementById('ticker-text');
            tEl.innerText = state.settings.ticker[l] || state.settings.ticker['en'];
            tEl.style.animation = l === 'ar' ? 'ticker-ltr 20s linear infinite' : 'ticker-rtl 20s linear infinite';
            
            renderProds();
        };

        window.renderProds = (cat=null, q=null) => {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            let list = state.products;
            if(cat) list = list.filter(p => p.cat == cat);
            if(q) list = list.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));

            list.forEach(p => {
                const pr = state.lang === 'ar' ? `${p.price_dz} DA` : `${p.price_eu} â‚¬`;
                grid.innerHTML += `
                    <div class="product-card" onclick="showPage('product', '${p.id}')">
                        <img src="${p.imgs[0]}" class="p-img">
                        <div class="p-info"><div class="p-cat">${p.cat}</div><div class="p-title">${p.name}</div><div class="p-price">${pr}</div></div>
                    </div>`;
            });
        };

        window.showPage = (pg, pid=null) => {
            document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active'));
            if(pg === 'home') document.getElementById('page-home').classList.add('active');
            if(pg === 'product') {
                const p = state.products.find(x => x.id == pid);
                if(p) {
                    document.getElementById('view-img').src = p.imgs[0];
                    document.getElementById('view-thumbs').innerHTML = p.imgs.map(s=>`<img src="${s}" class="thumb-img" onclick="document.getElementById('view-img').src='${s}'">`).join('');
                    document.getElementById('view-cat').innerText = p.cat;
                    document.getElementById('view-title').innerText = p.name;
                    document.getElementById('view-price').innerText = state.lang==='ar' ? p.price_dz+' DA' : p.price_eu+' â‚¬';
                    document.getElementById('view-desc').innerText = p.desc;
                    
                    // Documents Links
                    const docsDiv = document.getElementById('doc-links');
                    docsDiv.innerHTML = '';
                    if(p.cert) docsDiv.innerHTML += `<a href="${p.cert}" target="_blank" style="color:blue"><i class="fas fa-certificate"></i> Certificat Export</a>`;
                    if(p.fiche) docsDiv.innerHTML += `<a href="${p.fiche}" target="_blank" style="color:blue"><i class="fas fa-file-pdf"></i> Fiche Technique</a>`;

                    const cSel = document.getElementById('ord-color');
                    cSel.innerHTML = '';
                    p.colors.forEach(c => cSel.innerHTML += `<option>${c}</option>`);
                    window.currPid = pid;
                    document.getElementById('page-product').classList.add('active');
                }
            }
            window.scrollTo(0,0);
        };

        window.submitOrder = async () => {
            const p = state.products.find(x => x.id == window.currPid);
            const ord = {
                product: p.name,
                price: state.lang==='ar'?p.price_dz:p.price_eu,
                qty: document.getElementById('ord-qty').value,
                customer: document.getElementById('ord-name').value,
                phone: document.getElementById('ord-phone').value,
                date: new Date().toLocaleDateString()
            };
            if(db) await addDoc(collection(db, 'orders'), ord);
            else { state.orders.unshift(ord); updateAdmin(); }
            document.getElementById('success-overlay').style.display='flex';
            setTimeout(()=>{document.getElementById('success-overlay').style.display='none'; showPage('home');}, 2000);
        };

        // --- ADMIN ---
        window.openAdminLogin = () => document.getElementById('admin-login').style.display='flex';
        window.login = () => {
            if(document.getElementById('adm-user').value === 'admin' && document.getElementById('adm-pass').value === 'abobob123') {
                document.getElementById('admin-login').style.display='none';
                document.getElementById('page-home').classList.remove('active');
                document.getElementById('admin-panel').style.display='block';
                updateAdmin();
            } else document.getElementById('login-msg').style.display='block';
        };
        window.closeAdmin = () => { document.getElementById('admin-panel').style.display='none'; showPage('home'); };
        window.switchTab = (t) => {
            document.querySelectorAll('.admin-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            event.target.classList.add('active');
        };

        // --- EDIT / SAVE / IMPORT ---
        window.saveProduct = async () => {
            // Check ID for edit
            const editId = document.getElementById('edit-id').value;
            const id = editId || Date.now().toString();

            // Handling files (Simulated by Fake Path or manual URL)
            // In a real app, upload to Firebase Storage and get URL
            let imgUrls = document.getElementById('np-img').value.split(',').filter(x=>x);
            // Just simulated file read for demo
            if(imgUrls.length === 0) imgUrls = ['https://via.placeholder.com/400']; 
            
            const pData = {
                id: id,
                name: document.getElementById('np-name').value,
                cat: document.getElementById('np-cat').value,
                price_dz: Number(document.getElementById('np-price-dz').value),
                price_eu: Number(document.getElementById('np-price-eu').value),
                desc: document.getElementById('np-desc').value,
                colors: document.getElementById('np-colors').value.split(','),
                imgs: imgUrls,
                // These would be URLs in real life
                cert: document.getElementById('np-cert-file').value ? '#' : '',
                fiche: document.getElementById('np-fiche-file').value ? '#' : ''
            };

            if(db) await setDoc(doc(db, "products", id), pData);
            else {
                const idx = state.products.findIndex(x=>x.id == id);
                if(idx > -1) state.products[idx] = pData; else state.products.push(pData);
                renderProds(); updateAdmin();
            }
            alert('Saved');
            clearForm();
        };

        window.editProd = (id) => {
            const p = state.products.find(x => x.id == id);
            document.getElementById('edit-id').value = p.id;
            document.getElementById('np-name').value = p.name;
            document.getElementById('np-cat').value = p.cat;
            document.getElementById('np-price-dz').value = p.price_dz;
            document.getElementById('np-price-eu').value = p.price_eu;
            document.getElementById('np-desc').value = p.desc;
            document.getElementById('np-colors').value = p.colors;
            document.getElementById('np-img').value = p.imgs.join(',');
            window.scrollTo(0,0);
        };

        window.deleteProd = async (id) => {
            if(confirm('Delete?')) {
                if(db) await deleteDoc(doc(db, 'products', id));
                else { state.products = state.products.filter(x=>x.id!=id); renderProds(); updateAdmin(); }
            }
        };

        window.clearForm = () => {
            document.getElementById('edit-id').value='';
            document.querySelectorAll('#tab-products input, #tab-products textarea').forEach(i=>i.value='');
        };

        window.importCSV = () => {
            const f = document.getElementById('csv-file').files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const rows = e.target.result.split('\n');
                rows.forEach((r, i) => {
                    if(i>0 && r.length>5) {
                        const c = r.split(',');
                        const p = {id: Date.now()+i, name:c[0], cat:c[1], price_dz:c[2], price_eu:c[3], desc:c[4], imgs:['https://via.placeholder.com/300'], colors:[]};
                        if(db) setDoc(doc(db, 'products', p.id.toString()), p);
                        else state.products.push(p);
                    }
                });
                alert('Imported');
                renderProds(); updateAdmin();
            };
            r.readAsText(f);
        };

        window.saveGlobalSettings = async () => {
            const s = {
                theme: document.getElementById('set-theme').value,
                ticker: {
                    ar: document.getElementById('tick-ar').value,
                    fr: document.getElementById('tick-fr').value,
                    es: document.getElementById('tick-es').value,
                    en: document.getElementById('tick-en').value
                },
                slider: state.settings.slider
            };
            if(db) await setDoc(doc(db, 'settings', 'main'), s);
            else { state.settings = s; applySettings(); }
            alert('Updated All Users');
        };

        function updateAdmin() {
            document.getElementById('st-orders').innerText = state.orders.length;
            const pl = document.getElementById('admin-prod-list');
            pl.innerHTML = '';
            state.products.forEach(p => {
                pl.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <b>${p.name}</b>
                    <div>
                        <button onclick="editProd('${p.id}')" style="color:orange; cursor:pointer;">Edit</button>
                        <button onclick="deleteProd('${p.id}')" style="color:red; cursor:pointer;">Delete</button>
                    </div>
                </div>`;
            });
            const ot = document.getElementById('admin-orders-table');
            ot.innerHTML = '';
            state.orders.forEach(o => {
                ot.innerHTML += `<tr><td>${o.date}</td><td>${o.customer}</td><td>${o.product}</td><td>${o.price}</td></tr>`;
            });
        }

        function applySettings() {
            document.body.className = state.settings.theme;
            changeLang(state.lang);
            const sl = document.getElementById('slider-container');
            sl.innerHTML = state.settings.slider.map((s,i)=>`<img src="${s}" class="slide ${i==0?'active':''}">`).join('');
            // Restart slider loop
            let sI=0; setInterval(()=>{
                const ss = document.querySelectorAll('.slide');
                if(ss.length){ ss[sI].classList.remove('active'); sI=(sI+1)%ss.length; ss[sI].classList.add('active'); }
            }, 3000);
        }

        // --- INIT LISTENER ---
        if(db) {
            onSnapshot(collection(db, 'products'), (s)=>{
                let tmp=[]; s.forEach(d=>tmp.push(d.data())); state.products=tmp; 
                renderProds(); updateAdmin();
                // Generate cats
                const cats = [...new Set(tmp.map(p=>p.cat))];
                document.getElementById('cat-list').innerHTML = cats.map(c=>`<div class="cat-link" onclick="renderProds('${c}'); toggleSidebar()">${c}</div>`).join('');
            });
            onSnapshot(doc(db, 'settings', 'main'), (d)=>{
                if(d.exists()) { state.settings=d.data(); applySettings(); }
            });
            onSnapshot(collection(db, 'orders'), (s)=>{
                let tmp=[]; s.forEach(d=>tmp.push(d.data())); state.orders=tmp; updateAdmin();
            });
        } else {
            // Local Dummy
            state.products.push({id:'1', name:'Demo Lamp', cat:'Light', price_dz:1000, price_eu:5, desc:'Test', colors:['White'], imgs:['https://via.placeholder.com/300']});
            renderProds(); applySettings();
        }

        changeLang('ar');
    </script>
</body>
</html>
