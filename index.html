<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KahraLight Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME VARS --- */
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155;
            --text-main: #ffffff; --text-sub: #94a3b8;
            --primary: #3b82f6; --secondary: #f59e0b; --danger: #ef4444;
            --ticker-bg: #fff700; --ticker-text: #000;
            --radius: 12px; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        /* Light Theme */
        body.theme-light {
            --bg-body: #f8f9fa; --bg-card: #ffffff; --bg-input: #f1f5f9;
            --text-main: #1a1a1a; --text-sub: #64748b;
            --primary: #0044cc; --secondary: #ff9900;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Cairo', 'Roboto', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; padding-bottom: 0; overflow-x: hidden; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        img { max-width: 100%; display: block; }
        
        /* --- HEADER & SIDEBAR --- */
        header { background: var(--bg-card); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 900; box-shadow: var(--shadow); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { font-size: 26px; font-weight: 900; cursor: pointer; }
        .logo span:first-child { color: var(--primary); } .logo span:last-child { color: var(--secondary); text-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        
        .search-box { flex: 1; margin: 0 20px; max-width: 500px; display: none; }
        @media(min-width: 768px) { .search-box { display: block; } }
        .search-box input { width: 100%; padding: 10px 20px; border-radius: 30px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); }
        
        .nav-tools { display: flex; gap: 15px; align-items: center; }
        .lang-select { background: var(--bg-input); color: var(--text-main); border: none; padding: 5px; border-radius: 5px; cursor: pointer; }
        .icon-btn { font-size: 1.3rem; cursor: pointer; color: var(--text-sub); position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--secondary); color: #000; font-size: 10px; padding: 2px 5px; border-radius: 50%; }

        .sidebar { position: fixed; top: 0; width: 280px; height: 100%; background: var(--bg-card); z-index: 1000; padding: 20px; transition: 0.3s; box-shadow: var(--shadow); overflow-y: auto; }
        html[dir="rtl"] .sidebar { right: -300px; } html[dir="rtl"] .sidebar.active { right: 0; }
        html[dir="ltr"] .sidebar { left: -300px; } html[dir="ltr"] .sidebar.active { left: 0; }
        .cat-link { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; font-weight: 600; display:flex; justify-content:space-between; color: var(--text-sub); }
        .cat-link:hover, .cat-link.active { background: var(--primary); color: #fff; }

        /* --- PAGES --- */
        .page-view { display: none; min-height: 80vh; animation: fadeIn 0.4s; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* --- SLIDER & TICKER --- */
        .hero-slider { height: 250px; position: relative; overflow: hidden; }
        @media(min-width: 768px) { .hero-slider { height: 450px; } }
        .slide { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s; }
        .slide.active { opacity: 1; }

        .ticker-wrap { background: var(--ticker-bg); overflow: hidden; height: 40px; display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); white-space: nowrap; position: relative; }
        .ticker-content { display: inline-block; font-weight: 800; color: var(--ticker-text); font-size: 16px; position: absolute; }
        /* Keyframes injected via JS based on direction */

        /* --- PRODUCTS GRID --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); gap: 30px; } }
        
        .product-card { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; position: relative; cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .p-img { width: 100%; height: 200px; object-fit: contain; background: #fff; padding: 10px; }
        .p-info { padding: 15px; }
        .p-cat { font-size: 11px; color: var(--text-sub); text-transform: uppercase; font-weight: bold; }
        .p-title { font-weight: 700; margin: 5px 0; font-size: 15px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-price { color: var(--secondary); font-weight: 800; font-size: 1.1rem; }
        
        .out-stock-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; z-index: 2; }

        /* --- PRODUCT PAGE --- */
        #view-product { padding-top: 20px; }
        .prod-layout { display: flex; flex-direction: column; gap: 30px; }
        @media(min-width: 768px) { .prod-layout { flex-direction: row; } }
        .gallery { flex: 1; background: #fff; border-radius: 15px; padding: 20px; text-align: center; }
        .gallery img { max-height: 400px; width: auto; max-width: 100%; margin: 0 auto; }
        .thumbs { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
        .thumb { width: 60px; height: 60px; border: 2px solid #eee; cursor: pointer; object-fit: cover; }
        
        .details { flex: 1; }
        .dt-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; }
        .dt-price { font-size: 1.8rem; color: var(--secondary); font-weight: bold; margin-bottom: 20px; }
        .doc-btn { display: inline-flex; align-items: center; gap: 5px; padding: 10px; background: rgba(59, 130, 246, 0.1); color: var(--primary); border-radius: 5px; margin-right: 10px; font-weight: bold; margin-bottom: 20px; }
        
        .order-box { background: var(--bg-card); padding: 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .inp-field { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 5px; margin-bottom: 10px; }
        .btn-buy { width: 100%; padding: 15px; background: var(--secondary); color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-buy:disabled { background: #555; cursor: not-allowed; color: #888; }

        /* --- ADMIN PANEL --- */
        #view-admin { background: #f1f5f9; min-height: 100vh; color: #1e293b; display: none; }
        .admin-nav { background: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        .dash-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .d-card { padding: 20px; border-radius: 10px; color: #fff; height: 120px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .adm-tabs button { padding: 10px 20px; border: none; background: #cbd5e1; border-radius: 20px; margin-right: 5px; cursor: pointer; font-weight: bold; }
        .adm-tabs button.active { background: #1e293b; color: #fff; }
        
        .adm-section { background: #fff; padding: 25px; border-radius: 15px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .adm-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; }
        
        .img-list-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; background: #f8fafc; margin-bottom: 5px; border: 1px solid #eee; }
        .cat-item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }

        /* Helpers */
        .hidden { display: none !important; }
        .success-anim { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; flex-direction: column; color: #22c55e; }
        .login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body class="theme-dark">

    <!-- Header -->
    <header>
        <div style="display: flex; gap:15px; align-items: center;">
            <div class="icon-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
            <div class="logo" onclick="goHome()"><span>Kahra</span><span>Light</span></div>
        </div>
        <div class="search-box">
            <input type="text" onkeyup="renderProds(null, this.value)" placeholder="Search...">
        </div>
        <div class="nav-tools">
            <select class="lang-select" id="langSelect" onchange="changeLang(this.value)">
                <option value="es" selected>ðŸ‡ªðŸ‡¸ ES</option>
                <option value="ar">ðŸ‡©ðŸ‡¿ AR</option>
                <option value="fr">ðŸ‡«ðŸ‡· FR</option>
                <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
            </select>
            <div class="icon-btn" onclick="openAdminLogin()"><i class="fas fa-user-shield"></i></div>
            <div class="icon-btn"><i class="fas fa-shopping-cart"></i> <span class="badge" id="cartCount">0</span></div>
        </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
            <h3 data-key="categories">Categories</h3>
            <i class="fas fa-times" onclick="toggleSidebar()" style="cursor:pointer;"></i>
        </div>
        <div id="sidebar-cats"></div>
    </div>

    <!-- HOME PAGE -->
    <div id="view-home" class="page-view active">
        <div class="hero-slider" id="home-slider"></div>
        <div class="ticker-wrap"><div class="ticker-content" id="ticker-text"></div></div>
        
        <div class="container">
            <h2 style="margin-bottom: 20px; border-inline-start: 4px solid var(--secondary); padding-inline-start: 10px;" data-key="all_products">All Products</h2>
            <div class="grid" id="product-grid"></div>
        </div>
        
        <footer style="background:#000; color:#888; padding:40px 20px; text-align:center; margin-top:50px;">
            <p>&copy; 2026 KahraLight Store.</p>
        </footer>
    </div>

    <!-- PRODUCT PAGE -->
    <div id="view-product" class="page-view">
        <div class="container">
            <div style="margin-bottom:20px; cursor:pointer;" onclick="goHome()">
                <i class="fas fa-arrow-left"></i> <span data-key="back">Back</span>
            </div>
            
            <div class="prod-layout">
                <div class="gallery">
                    <img id="dt-img" src="">
                    <div class="thumbs" id="dt-thumbs"></div>
                </div>
                
                <div class="details">
                    <div id="dt-cat" style="color:var(--primary); font-weight:bold; font-size:12px;"></div>
                    <h1 id="dt-title" class="dt-title"></h1>
                    <div id="dt-price" class="dt-price"></div>
                    
                    <div id="stock-status" style="margin-bottom:15px; font-weight:bold;"></div>
                    
                    <div id="dt-docs" style="margin-bottom:20px;"></div>
                    <div id="dt-desc" style="color:var(--text-sub); margin-bottom:25px; line-height:1.6;"></div>
                    
                    <div class="order-box">
                        <h3 style="margin-bottom:15px;" data-key="order_form">Order Form</h3>
                        
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1">
                                <label style="font-size:12px;" data-key="qty">Qty</label>
                                <input type="number" id="ord-qty" value="1" min="1" class="inp-field">
                            </div>
                            <div style="flex:1" id="color-wrapper">
                                <label style="font-size:12px;" data-key="color">Color</label>
                                <select id="ord-color" class="inp-field"></select>
                            </div>
                        </div>

                        <label style="font-size:12px;" data-key="name">Name</label>
                        <input type="text" id="ord-name" class="inp-field">
                        
                        <label style="font-size:12px;" data-key="phone">Phone</label>
                        <input type="tel" id="ord-phone" class="inp-field">
                        
                        <label style="font-size:12px;" data-key="country">Country</label>
                        <select id="ord-country" class="inp-field">
                            <option>Algeria</option><option>France</option><option>Spain</option><option>Portugal</option>
                        </select>
                        
                        <label style="font-size:12px;" data-key="address">Address</label>
                        <input type="text" id="ord-addr" class="inp-field">
                        
                        <button id="btn-buy" class="btn-buy" onclick="placeOrder()" data-key="buy_now">CONFIRM ORDER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="view-admin">
        <div class="admin-nav">
            <h3>Admin Panel</h3>
            <button onclick="goHome()" style="padding:8px 15px; cursor:pointer;">Exit</button>
        </div>
        
        <div class="admin-container">
            <!-- Dashboard -->
            <div class="dash-cards">
                <div class="d-card" style="background:linear-gradient(135deg, #3b82f6, #2563eb);"><h3>1.2K</h3><p>Visits</p></div>
                <div class="d-card" style="background:linear-gradient(135deg, #f59e0b, #d97706);"><h3 id="st-orders">0</h3><p>Orders</p></div>
                <div class="d-card" style="background:linear-gradient(135deg, #22c55e, #16a34a);"><h3 id="st-prods">0</h3><p>Products</p></div>
                <div class="d-card" style="background:linear-gradient(135deg, #a855f7, #9333ea);"><h3>Active</h3><p>Status</p></div>
            </div>

            <!-- Tabs -->
            <div class="adm-tabs">
                <button class="active" onclick="admTab('prods')">Products</button>
                <button onclick="admTab('cats')">Categories</button>
                <button onclick="admTab('slider')">Slider</button>
                <button onclick="admTab('settings')">Settings</button>
            </div>

            <!-- Tab: Products -->
            <div id="tab-prods" class="adm-section">
                <h3>Add / Edit Product</h3>
                <input type="hidden" id="p-id">
                
                <div style="display:flex; gap:10px;">
                    <input type="text" id="p-name" placeholder="Name" class="adm-input">
                    <select id="p-cat" class="adm-input"></select>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="p-price-da" placeholder="Price DA" class="adm-input">
                    <input type="number" id="p-price-eu" placeholder="Price â‚¬" class="adm-input">
                </div>
                <textarea id="p-desc" placeholder="Description" class="adm-input"></textarea>
                
                <label>Options:</label>
                <div style="margin:10px 0; display:flex; gap:20px;">
                    <label><input type="checkbox" id="p-stock" checked> In Stock</label>
                    <label><input type="checkbox" id="p-has-color" checked onchange="toggleColorInput()"> Has Colors</label>
                </div>
                
                <input type="text" id="p-colors" placeholder="Colors (red, blue...)" class="adm-input">
                
                <label>Images (URLs):</label>
                <input type="text" id="p-img-url" placeholder="Main Image URL" class="adm-input">
                <input type="text" id="p-img-multi" placeholder="Other Images (comma separated)" class="adm-input">
                
                <label>Documents (URLs or Upload simulation):</label>
                <input type="text" id="p-cert" placeholder="Certificat URL" class="adm-input">
                <input type="text" id="p-fiche" placeholder="Fiche Technique URL" class="adm-input">
                
                <button onclick="saveProduct()" style="padding:10px 20px; background:green; color:white; border:none; border-radius:5px; cursor:pointer;">Save Product</button>
                <button onclick="clearProdForm()" style="padding:10px; cursor:pointer;">Clear</button>
                
                <hr style="margin:20px 0;">
                <div id="adm-prod-list"></div>
            </div>

            <!-- Tab: Categories -->
            <div id="tab-cats" class="adm-section hidden">
                <h3>Manage Categories</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-cat-name" placeholder="Category Name" class="adm-input">
                    <button onclick="addCategory()" style="padding:0 20px; height:42px; cursor:pointer;">Add</button>
                </div>
                <div id="adm-cat-list"></div>
            </div>

            <!-- Tab: Slider -->
            <div id="tab-slider" class="adm-section hidden">
                <h3>Slider Images</h3>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-slide-url" placeholder="Image URL" class="adm-input">
                    <button onclick="addSlide()" style="padding:0 20px; height:42px; cursor:pointer;">Add</button>
                </div>
                <div id="adm-slide-list"></div>
            </div>

            <!-- Tab: Settings (Ticker + Theme) -->
            <div id="tab-settings" class="adm-section hidden">
                <h3>Ticker Text (4 Languages)</h3>
                <input type="text" id="t-ar" placeholder="Arabic" class="adm-input">
                <input type="text" id="t-fr" placeholder="French" class="adm-input">
                <input type="text" id="t-es" placeholder="Spanish" class="adm-input">
                <input type="text" id="t-en" placeholder="English" class="adm-input">
                
                <h3>Theme</h3>
                <select id="set-theme" class="adm-input">
                    <option value="theme-dark">Dark Blue</option>
                    <option value="theme-light">Light</option>
                </select>
                
                <button onclick="saveSettings()" style="padding:10px 20px; background:blue; color:white; border:none; cursor:pointer;">Update Settings</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="login-overlay">
        <div style="background:var(--bg-card); padding:30px; border-radius:10px; width:300px; text-align:center;">
            <h3>Admin Login</h3>
            <input type="password" id="adm-pass" placeholder="Password" class="inp-field" style="margin:15px 0;">
            <button onclick="checkLogin()" class="btn-buy" style="padding:10px;">Login</button>
            <button onclick="document.getElementById('login-modal').style.display='none'" style="margin-top:10px; background:none; border:none; color:var(--text-sub); cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="success-msg" class="success-anim">
        <i class="fas fa-check-circle" style="font-size:4rem; margin-bottom:15px;"></i>
        <h2>Order Successful!</h2>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
          projectId: "mourafik-e9161",
          appId: "1:133465287328:web:9de5b3bd709099d885b7c5"
        };
        
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch(e){console.log("Local Mode");}

        // STATE
        let state = {
            lang: 'es', // Default Spanish
            currency: 'â‚¬',
            cats: ['Lighting', 'Cables', 'Decor'],
            products: [],
            slider: [],
            ticker: { ar:'', fr:'', es:'', en:'' },
            theme: 'theme-dark'
        };

        const i18n = {
            ar: { all_products: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', categories:'Ø§Ù„ÙØ¦Ø§Øª', back:'Ø¹ÙˆØ¯Ø©', order_form:'Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨', buy_now:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨', qty:'Ø§Ù„ÙƒÙ…ÙŠØ©', color:'Ø§Ù„Ù„ÙˆÙ†', name:'Ø§Ù„Ø§Ø³Ù…', phone:'Ø§Ù„Ù‡Ø§ØªÙ', country:'Ø§Ù„Ø¨Ù„Ø¯', address:'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', stock_in:'Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', stock_out:'Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©' },
            fr: { all_products: 'Tous les produits', categories:'CatÃ©gories', back:'Retour', order_form:'Bon de commande', buy_now:'Confirmer', qty:'QuantitÃ©', color:'Couleur', name:'Nom', phone:'TÃ©lÃ©phone', country:'Pays', address:'Adresse', stock_in:'En Stock', stock_out:'Rupture de stock' },
            en: { all_products: 'All Products', categories:'Categories', back:'Back', order_form:'Order Form', buy_now:'Confirm', qty:'Qty', color:'Color', name:'Name', phone:'Phone', country:'Country', address:'Address', stock_in:'In Stock', stock_out:'Out of Stock' },
            es: { all_products: 'Todos los productos', categories:'CategorÃ­as', back:'Volver', order_form:'Formulario de pedido', buy_now:'Confirmar', qty:'Cantidad', color:'Color', name:'Nombre', phone:'TelÃ©fono', country:'PaÃ­s', address:'DirecciÃ³n', stock_in:'En Stock', stock_out:'Agotado' }
        };

        // --- CORE ---
        window.changeLang = (l) => {
            state.lang = l;
            document.documentElement.lang = l;
            document.documentElement.dir = (l==='ar') ? 'rtl' : 'ltr';
            state.currency = (l==='ar') ? 'DA' : 'â‚¬';
            
            // Translations
            document.querySelectorAll('[data-key]').forEach(el => {
                if(i18n[l][el.dataset.key]) el.innerText = i18n[l][el.dataset.key];
            });

            // Ticker
            const t = document.getElementById('ticker-text');
            t.innerText = state.ticker[l] || state.ticker['en'] || "Welcome to KahraLight";
            
            const animName = (l==='ar') ? 'ticker-ltr' : 'ticker-rtl';
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes ticker-rtl { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
                @keyframes ticker-ltr { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
            `;
            document.head.appendChild(style);
            t.style.animation = `${animName} 20s linear infinite`;

            renderGrid();
        };

        window.goHome = () => {
            document.querySelectorAll('.page-view').forEach(e => e.classList.remove('active'));
            document.getElementById('view-home').classList.add('active');
            window.history.pushState({}, '', '/kahralight/');
            window.scrollTo(0,0);
        };

        window.renderGrid = (catFilter=null, search=null) => {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            let list = state.products;
            if(catFilter) list = list.filter(p => p.cat === catFilter);
            if(search) list = list.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

            list.forEach(p => {
                const price = (state.lang==='ar') ? p.price_da : p.price_eu;
                // Translated Stock Badge
                const stockText = i18n[state.lang].stock_out;
                const stockBadge = (!p.inStock) ? `<div class="out-stock-badge">${stockText}</div>` : '';
                grid.innerHTML += `
                    <div class="product-card" onclick="openProduct('${p.id}')">
                        ${stockBadge}
                        <img src="${p.imgs[0]}" class="p-img">
                        <div class="p-info">
                            <div class="p-cat">${p.cat}</div>
                            <div class="p-title">${p.name}</div>
                            <div class="p-price">${price} ${state.currency}</div>
                        </div>
                    </div>`;
            });
        };

        window.openProduct = (id) => {
            const p = state.products.find(x => x.id == id);
            if(!p) return;
            
            // URL Format
            const niceUrl = `/kahralight/${encodeURIComponent(p.cat)}/${encodeURIComponent(p.name.replace(/\s+/g, '-'))}`;
            window.history.pushState({}, '', niceUrl);

            document.querySelectorAll('.page-view').forEach(e => e.classList.remove('active'));
            document.getElementById('view-product').classList.add('active');
            window.scrollTo(0,0);

            // Populate
            document.getElementById('dt-img').src = p.imgs[0];
            document.getElementById('dt-thumbs').innerHTML = p.imgs.map(u => `<img src="${u}" class="thumb" onclick="document.getElementById('dt-img').src='${u}'">`).join('');
            document.getElementById('dt-cat').innerText = p.cat;
            document.getElementById('dt-title').innerText = p.name;
            document.getElementById('dt-price').innerText = (state.lang==='ar' ? p.price_da : p.price_eu) + ' ' + state.currency;
            document.getElementById('dt-desc').innerText = p.desc;
            
            // Stock Status (Translated)
            const sDiv = document.getElementById('stock-status');
            const btn = document.getElementById('btn-buy');
            if(p.inStock) {
                sDiv.innerHTML = `<span style="color:#22c55e"><i class="fas fa-check"></i> ${i18n[state.lang].stock_in}</span>`;
                btn.disabled = false;
                btn.innerText = i18n[state.lang].buy_now;
            } else {
                sDiv.innerHTML = `<span style="color:red"><i class="fas fa-times"></i> ${i18n[state.lang].stock_out}</span>`;
                btn.disabled = true;
                btn.innerText = i18n[state.lang].stock_out;
            }

            // Colors
            const cWrap = document.getElementById('color-wrapper');
            const cSel = document.getElementById('ord-color');
            cSel.innerHTML = '';
            if(p.hasColors && p.colors && p.colors.length > 0) {
                cWrap.style.display = 'block';
                p.colors.forEach(c => cSel.innerHTML += `<option>${c}</option>`);
            } else {
                cWrap.style.display = 'none';
            }

            // Docs
            const dDiv = document.getElementById('dt-docs');
            dDiv.innerHTML = '';
            if(p.cert) dDiv.innerHTML += `<a href="${p.cert}" target="_blank" class="doc-btn"><i class="fas fa-certificate"></i> Certificat</a>`;
            if(p.fiche) dDiv.innerHTML += `<a href="${p.fiche}" target="_blank" class="doc-btn"><i class="fas fa-file-pdf"></i> Fiche Tech.</a>`;

            window.currPid = id;
        };

        window.placeOrder = async () => {
            const p = state.products.find(x => x.id == window.currPid);
            const ord = {
                product: p.name,
                price: (state.lang==='ar')?p.price_da:p.price_eu,
                qty: document.getElementById('ord-qty').value,
                color: (p.hasColors) ? document.getElementById('ord-color').value : 'Default',
                name: document.getElementById('ord-name').value,
                phone: document.getElementById('ord-phone').value,
                date: new Date().toLocaleDateString()
            };
            if(!ord.name || !ord.phone) return alert('Fill name & phone');
            if(db) await addDoc(collection(db, 'orders'), ord);
            document.getElementById('success-msg').style.display='flex';
            setTimeout(() => { document.getElementById('success-msg').style.display='none'; goHome(); }, 2000);
        };

        // --- ADMIN ---
        window.openAdminLogin = () => document.getElementById('login-modal').style.display = 'flex';
        window.checkLogin = () => {
            const p = document.getElementById('adm-pass').value;
            if(p === 'abobob123') {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('view-home').classList.remove('active');
                document.getElementById('view-admin').style.display = 'block';
                renderAdminData();
            } else {
                alert('Wrong Password');
            }
        };

        window.admTab = (t) => {
            document.querySelectorAll('.adm-section').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.adm-tabs button').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            event.target.classList.add('active');
        };

        // --- CATEGORY MANAGEMENT ---
        window.addCategory = async () => {
            const n = document.getElementById('new-cat-name').value;
            if(n) {
                state.cats.push(n);
                if(db) await setDoc(doc(db, 'settings', 'cats'), {list: state.cats});
                renderAdminData();
            }
        };
        window.delCat = async (idx) => {
            state.cats.splice(idx, 1);
            if(db) await setDoc(doc(db, 'settings', 'cats'), {list: state.cats});
            renderAdminData();
        };

        // --- SLIDER MANAGEMENT ---
        window.addSlide = async () => {
            const u = document.getElementById('new-slide-url').value;
            if(u) {
                state.slider.push(u);
                if(db) await setDoc(doc(db, 'settings', 'slider'), {list: state.slider});
                renderAdminData();
            }
        };
        window.delSlide = async (idx) => {
            state.slider.splice(idx, 1);
            if(db) await setDoc(doc(db, 'settings', 'slider'), {list: state.slider});
            renderAdminData();
        };

        // --- PRODUCT MANAGEMENT ---
        window.saveProduct = async () => {
            const id = document.getElementById('p-id').value || Date.now().toString();
            // Images
            let imgs = [document.getElementById('p-img-url').value];
            const multi = document.getElementById('p-img-multi').value;
            if(multi) imgs = imgs.concat(multi.split(','));
            imgs = imgs.filter(x => x); // clean empty

            const data = {
                id: id,
                name: document.getElementById('p-name').value,
                cat: document.getElementById('p-cat').value,
                price_da: Number(document.getElementById('p-price-da').value),
                price_eu: Number(document.getElementById('p-price-eu').value),
                desc: document.getElementById('p-desc').value,
                inStock: document.getElementById('p-stock').checked,
                hasColors: document.getElementById('p-has-color').checked,
                colors: document.getElementById('p-colors').value.split(','),
                imgs: imgs,
                cert: document.getElementById('p-cert').value,
                fiche: document.getElementById('p-fiche').value
            };

            if(db) await setDoc(doc(db, 'products', id), data);
            else {
                const idx = state.products.findIndex(x=>x.id==id);
                if(idx>-1) state.products[idx] = data; else state.products.push(data);
                renderAdminData();
            }
            clearProdForm();
            alert('Product Saved');
        };

        window.editProd = (id) => {
            const p = state.products.find(x => x.id == id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-cat').value = p.cat;
            document.getElementById('p-price-da').value = p.price_da;
            document.getElementById('p-price-eu').value = p.price_eu;
            document.getElementById('p-desc').value = p.desc;
            document.getElementById('p-stock').checked = p.inStock;
            document.getElementById('p-has-color').checked = p.hasColors;
            document.getElementById('p-colors').value = p.colors;
            document.getElementById('p-img-url').value = p.imgs[0];
            document.getElementById('p-img-multi').value = p.imgs.slice(1).join(',');
            document.getElementById('p-cert').value = p.cert || '';
            document.getElementById('p-fiche').value = p.fiche || '';
            toggleColorInput();
            window.scrollTo(0,0);
        };

        window.delProd = async (id) => {
            if(confirm('Delete?')) {
                if(db) await deleteDoc(doc(db, 'products', id));
                else { state.products = state.products.filter(x=>x.id!=id); renderAdminData(); }
            }
        };

        window.toggleColorInput = () => {
            const has = document.getElementById('p-has-color').checked;
            document.getElementById('p-colors').style.display = has ? 'block' : 'none';
        };

        window.clearProdForm = () => {
            document.getElementById('p-id').value = '';
            document.querySelectorAll('#tab-prods input, #tab-prods textarea').forEach(i => i.value = '');
            document.getElementById('p-stock').checked = true;
            document.getElementById('p-has-color').checked = true;
        };

        // --- SETTINGS (TICKER) ---
        window.saveSettings = async () => {
            const s = {
                ticker: {
                    ar: document.getElementById('t-ar').value,
                    fr: document.getElementById('t-fr').value,
                    es: document.getElementById('t-es').value,
                    en: document.getElementById('t-en').value
                },
                theme: document.getElementById('set-theme').value
            };
            if(db) await setDoc(doc(db, 'settings', 'main'), s);
            alert('Updated!');
        };

        function renderAdminData() {
            document.getElementById('st-prods').innerText = state.products.length;
            
            // Cat Select
            const catSel = document.getElementById('p-cat');
            catSel.innerHTML = state.cats.map(c => `<option>${c}</option>`).join('');

            // Cat List (Manage)
            document.getElementById('adm-cat-list').innerHTML = state.cats.map((c,i) => `
                <div class="cat-item-row">
                    <b>${c}</b>
                    <button onclick="delCat(${i})" style="color:red; background:none; border:none; cursor:pointer;">Delete</button>
                </div>
            `).join('');

            // Slider List (Manage)
            document.getElementById('adm-slide-list').innerHTML = state.slider.map((s,i) => `
                <div class="img-list-item">
                    <img src="${s}" style="width:50px; height:30px; object-fit:cover;">
                    <button onclick="delSlide(${i})" style="color:red; background:none; border:none; cursor:pointer;">X</button>
                </div>
            `).join('');

            // Prod List
            document.getElementById('adm-prod-list').innerHTML = state.products.map(p => `
                <div class="cat-item-row">
                    <span>${p.name}</span>
                    <div>
                        <button onclick="editProd('${p.id}')" style="color:blue; margin-right:5px; cursor:pointer;">Edit</button>
                        <button onclick="delProd('${p.id}')" style="color:red; cursor:pointer;">Delete</button>
                    </div>
                </div>
            `).join('');
            
            // Fill Settings
            document.getElementById('t-ar').value = state.ticker.ar;
            document.getElementById('t-fr').value = state.ticker.fr;
            document.getElementById('t-es').value = state.ticker.es;
            document.getElementById('t-en').value = state.ticker.en;
            document.getElementById('set-theme').value = state.theme;
        }

        // --- INITIALIZATION ---
        function applyGlobal() {
            document.body.className = state.theme;
            
            // Sidebar Cats (Render ANY category added by admin)
            document.getElementById('sidebar-cats').innerHTML = 
                `<div class="cat-link" onclick="renderGrid()">All / Todos</div>` + 
                state.cats.map(c => `<div class="cat-link" onclick="renderGrid('${c}')">${c}</div>`).join('');
            
            // Slider
            const sl = document.getElementById('home-slider');
            sl.innerHTML = state.slider.map((s,i) => `<img src="${s}" class="slide ${i==0?'active':''}">`).join('');
            
            // Auto Slide
            if(window.slideInt) clearInterval(window.slideInt);
            let si = 0;
            window.slideInt = setInterval(() => {
                const ss = document.querySelectorAll('.slide');
                if(ss.length){
                    ss[si].classList.remove('active');
                    si = (si+1)%ss.length;
                    ss[si].classList.add('active');
                }
            }, 3000);

            // Re-apply language to catch new elements
            changeLang(state.lang);
        }

        if(db) {
            // Load Settings
            onSnapshot(doc(db, 'settings', 'main'), d => { if(d.exists()){ 
                const dd = d.data(); 
                state.ticker = dd.ticker; state.theme = dd.theme;
                applyGlobal();
            }});
            // Load Cats
            onSnapshot(doc(db, 'settings', 'cats'), d => { if(d.exists()){ state.cats = d.data().list; applyGlobal(); }});
            // Load Slider
            onSnapshot(doc(db, 'settings', 'slider'), d => { if(d.exists()){ state.slider = d.data().list; applyGlobal(); }});
            // Load Products
            onSnapshot(collection(db, 'products'), s => { 
                let t=[]; s.forEach(d=>t.push(d.data())); 
                state.products=t; renderGrid(); 
            });
        } else {
            // Demo Data
            state.cats = ['Lighting', 'Cables'];
            state.slider = ['https://via.placeholder.com/1200x450/0033cc/fff?text=Demo1', 'https://via.placeholder.com/1200x450/ff9900/fff?text=Demo2'];
            state.products = [{
                id:'1', name:'Demo Lamp', cat:'Lighting', price_da:1000, price_eu:5, desc:'Test', 
                inStock:true, hasColors:true, colors:['White'], imgs:['https://via.placeholder.com/400']
            }];
            applyGlobal();
        }

        toggleColorInput();
        changeLang('es'); // Enforce Spanish default
    </script>
</body>
</html>
